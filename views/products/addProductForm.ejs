<!-- 
  Expected input data from backend:
    - product (optional): The product object if editing; undefined/null if creating a new product.
    - editing: Boolean (true for editing, false for creating a new product).
    - metaCategories: Array of meta category objects (each { _id, name }).
    - mainCategories: Array of main category objects (each { _id, name, meta }).
    - subCategories: Array of sub category objects (each { _id, name, main }).

  Fields provided by this form on submission:
    - productId: Hidden input (only populated if editing).
    - newImages: input[type="file"], multiple. New images uploaded by the user.
    - existingImages[]: Hidden inputs holding URLs of kept existing images.
    - removedImages[]: Hidden inputs holding URLs of images the user chose to delete.
    - metaCategoryId: Selected meta category ID.
    - mainCategoryId: Selected main category ID.
    - subCategoryId: Selected sub category ID.
    - name: Product name (text input).
    - description: Product description (textarea).
    - price: Product price (number input).
    - salePrice: Sale price if applicable (optional number input).
    - brand: Brand name (text input).
    - stock: Stock quantity (number input).

  Variant fields submitted as an array of objects:
    - variants[0][name]   // (required) Name of the first variant
    - variants[0][price]  // (optional) Price of the first variant
    - variants[0][image]  // (optional) Image URL or path of the first variant

    - variants[1][name]   // (required) Name of the second variant
    - variants[1][price]  // (optional) Price of the second variant
    - variants[1][image]  // (optional) Image URL or path of the second variant

    - ...and so on for each additional variant.
-->

<div class="add-product-form">
  <div>
    <h1><%= editing ? 'Edit Product' : 'Create a New Product' %></h1>

    <form id="productForm" enctype="multipart/form-data">

      <!-- Hidden product ID (for edit mode) -->
      <% if (editing && product?._id) { %>
        <input type="hidden" id="productId" name="productId" value="<%= product._id %>" />
      <% } %>

      <!-- Image Uploader Partial -->
      <%- include('../partials/products/imageUploader', { 
        images: product?.images || [], 
        editing 
      }) %>

      <!-- Category Selector Partial -->
      <%- include('../partials/categories/select', {
        metaCategories,
        mainCategories,
        subCategories,
        editing,
        selectedMeta: product?.metaCategory?._id || '',
        selectedMain: product?.mainCategory?._id || '',
        selectedSub: product?.subCategory?._id || ''
      }) %>

      <div>
        <label for="name">Product Name:</label>
        <input type="text" id="name" name="name" value="<%= product?.name || '' %>" required />
      </div>

      <div>
        <label for="description">Product Description:</label>
        <textarea id="description" name="description" required><%= product?.description || '' %></textarea>
      </div>

      <% if (!variants) { %>
          <div>
    <label for="price">Price:</label>
    <input type="number" id="price" name="price" value="<%= product?.price || '' %>" required />
  </div>

          <div>
    <label for="salePrice">Sale Price:</label>
    <input type="number" id="salePrice" name="salePrice" value="<%= product?.salePrice || '' %>" required />
  </div>

          <div>
    <label for="stock">Stock Quantity:</label>
    <input type="number" id="stock" name="stock" value="<%= product?.stock || '' %>" required />
  </div>
      <% } %>

      <div>
        <label for="brand">Brand:</label>
        <input type="text" id="brand" name="brand" value="<%= product?.brand || '' %>" required />
      </div>

      <!-- Variant Partial -->
      <% if (variants) { %>
        <%- include('../partials/products/variants', { 
            variants: product?.variants || [], 
            editing 
        }) %>
      <% } %>

      <button id="submit-button" type="submit">
        <%= editing ? 'Update Product' : 'Create Product' %>
      </button>
    </form>
  </div>
</div>

<script>
  const productForm = document.getElementById('productForm');

  // Check if the form has a hidden input for the productId (indicating that we're editing)
  const productId = document.querySelector('input[name="productId"]')?.value;

  // Define the route dynamically based on whether editing or creating
  const route = editing ? `/products/${productId}` : '/products';
  
  // Handle form submission
  productForm.addEventListener('submit', async (event) => {
    event.preventDefault(); // Prevent default form submission

    // Collect form data, including new images and removed images
    const formData = new FormData(productForm);
    if (Array.isArray(window.removedExistingURLs) && window.removedExistingURLs.length > 0) {
  window.removedExistingURLs.forEach((url) => {
    formData.append('removedImages[]', url);
  });
}

    try {
      const response = await fetch(route, {
        method: editing ? 'PUT' : 'POST', // Use PUT for editing, POST for new product
        body: formData,
      });

      if (response.ok) {
        const result = await response.json();
        alert('Product saved successfully!');
        window.location.href = '/products'; // Redirect to product listing page
      } else {
        const error = await response.json();
        alert('Error: ' + (error.message || 'Something went wrong.'));
      }
    } catch (err) {
      console.error(err);
      alert('Error submitting the form.');
    }
  });
</script>

<!-- 
Main form fields (exclusive of partials):

- productId (hidden, only if editing)
- name (Product Name) - input[type="text"]
- description (Product Description) - textarea
- price (Price) - input[type="number"]
- salePrice (Sale Price, optional) - input[type="number"]
- brand (Brand Name) - input[type="text"]
- stock (Stock Quantity) - input[type="number"]

-->