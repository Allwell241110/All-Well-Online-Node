<div class="checkout-confirm-container">
  <h1>Order Confirmation</h1>

  <h3>Delivering to:</h3>
  <p>
    <strong>District:</strong> <%= deliveryAddress.district %><br>
    <strong>Village:</strong> <%= deliveryAddress.village %><br>
    <strong>Street:</strong> <%= deliveryAddress.street %>
  </p>

  <p><strong>Payment Method:</strong> 
    <%= paymentMethod === 'cod' ? 'Cash on Delivery' : 'MTN Mobile Money' %>
  </p>

  <div class="cart-table-wrapper">
    <table class="cart-table">
    <thead>
      <tr>
        <th>Product</th>
        <th>Price</th>
        <th>Qty</th>
        <th>Subtotal</th>
      </tr>
    </thead>
    <tbody>
      <% let total = 0; %>
      <% cart.forEach(item => {
        const price = item.price || 0;
        const subtotal = price * item.quantity;
        total += subtotal;
      %>
        <tr>
          <td class="product-name">
  <div class="clamp">
    <%= item.name %>
    <% if (item.variantName) { %>
      <small>(<%= item.variantName %>)</small>
    <% } %>
  </div>
</td>
          <td>UGX <%= price.toLocaleString() %></td>
          <td><%= item.quantity %></td>
          <td>UGX <%= subtotal.toLocaleString() %></td>
        </tr>
      <% }) %>
    </tbody>
  </table>
  </div>

  <p><strong>Subtotal:</strong> UGX <%= total.toLocaleString() %></p>
  <p><strong>Delivery Fee:</strong> UGX <%= deliveryFee.toLocaleString() %></p>
  <h3>Total: UGX <%= (total + deliveryFee).toLocaleString() %></h3>

  <form id="checkoutForm" action="/checkout/process" method="POST">
    <input type="hidden" name="paymentMethod" value="<%= paymentMethod %>">
    <input type="hidden" name="totalAmount" value="<%= total + deliveryFee %>">

    <!-- Delivery address fields -->
    <input type="hidden" name="deliveryAddress[district]" value="<%= deliveryAddress.district %>">
    <input type="hidden" name="deliveryAddress[village]" value="<%= deliveryAddress.village %>">
    <input type="hidden" name="deliveryAddress[street]" value="<%= deliveryAddress.street %>">

    <% if (paymentMethod === 'prepaid') { %>
      <label for="momoNumber">Enter MTN Mobile Money Number:</label>
      <input type="tel" id="momoNumber" name="momoNumber" required placeholder="e.g. 077xxxxxxx">
      <button type="submit">Make Payment</button>
    <% } else { %>
      <button type="submit">Place Order</button>
    <% } %>
  </form>

  <script>
  document.getElementById('checkoutForm')?.addEventListener('submit', function (e) {
    const paymentMethod = "<%= paymentMethod %>";
    const numberInput = document.getElementById('momoNumber');
    
    // For prepaid method, validate number
    if (paymentMethod === 'prepaid') {
      const number = numberInput.value.trim();
      const validPrefixes = ['077', '078', '076'];

      if (!/^\d{10}$/.test(number) || !validPrefixes.includes(number.slice(0, 3))) {
        e.preventDefault();
        alert("Please enter a valid 10-digit MTN number starting with 077, 078, or 076.");
        numberInput.focus();
        return;
      }
    }

    // Track Facebook Purchase Event
    fbq('track', 'Purchase', {
      value: <%= (total + deliveryFee).toFixed(2) %>,
      currency: 'UGX'
    });

    // Track Google Purchase Event
    gtag('event', 'purchase', {
      transaction_id: '<%= Date.now() %>', // Or your actual order ID
      value: <%= (total + deliveryFee).toFixed(2) %>,
      currency: 'UGX',
      items: [
        <% cart.forEach((item, i) => { %>
          {
            id: "<%= item._id %>",
            name: "<%= item.name.replace(/"/g, '\\"') %>",
            quantity: <%= item.quantity %>,
            price: <%= (item.price || 0).toFixed(2) %>
          }<%= i < cart.length - 1 ? ',' : '' %>
        <% }) %>
      ]
    });
  });
</script>
</div>