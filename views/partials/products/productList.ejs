<%
  function slugify(text) {
    return text.toString().toLowerCase().trim()
      .replace(/[^a-z0-9\s-]/g, '')
      .replace(/\s+/g, '-')
      .replace(/-+/g, '-');
  }
%>

<div class="product-grid">
  <% products.forEach(product => { 
       const hasVariants = product.variants && product.variants.length > 0;
       let editUrl = `/products/edit/${product._id}${hasVariants ? '?variants=true' : ''}`;

       let minVariantPrice = null;
       let maxVariantPrice = null;

       if (hasVariants) {
         const finalPrices = product.variants.map(v => v.salePrice ?? v.price);
         minVariantPrice = Math.min(...finalPrices);
         maxVariantPrice = Math.max(...finalPrices);
       }

       const slug = slugify(product.name);
       const viewUrl = `/products/${product._id}-${slug}`;
  %>
    <div class="product-card" data-id="<%= product._id %>" data-slug="<%= slug %>">
      <% if (product.images && product.images.length > 0) { %>
        <img src="<%= product.images[0].url %>" alt="<%= product.name %>" loading="lazy">
      <% } else { %>
        <img src="/images/placeholder.png" alt="No Image Available">
      <% } %>

      <h3><%= product.name %></h3>
      <p class="price">
        <% if (hasVariants) { %>
          <% if (minVariantPrice !== maxVariantPrice) { %>
            <span class="discounted">UGX <%= minVariantPrice.toLocaleString() %> - UGX <%= maxVariantPrice.toLocaleString() %></span>
          <% } else { %>
            <span class="discounted">UGX <%= minVariantPrice.toLocaleString() %></span>
          <% } %>
        <% } else { %>
          <% if (product.price !== product.salePrice) { %>
            <span class="original">UGX <%= product.price.toLocaleString() %></span>
            <span class="discounted">UGX <%= product.salePrice.toLocaleString() %></span>
            <span class="percent">(-<%= Math.round((product.price - product.salePrice) / product.price * 100) %>%)</span>
          <% } else { %>
            <span class="discounted">UGX <%= product.price.toLocaleString() %></span>
          <% } %>
        <% } %>
      </p>

      <% if (user && user.role === 'admin') { %>
        <a class="edit-link" href="<%= editUrl %>">Edit</a>
        <button type="button" class="delete-link" onclick="deleteProduct('<%= product._id %>')">Delete</button>
      <% } %>
    </div>
  <% }) %>
</div>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    // Handle product card click (excluding buttons and links)
    document.querySelectorAll(".product-card").forEach(card => {
      card.addEventListener("click", (event) => {
        if (event.target.closest("button, a")) return;
        const id = card.getAttribute("data-id");
        const slug = card.getAttribute("data-slug");
        if (id && slug) {
          window.location.href = `/products/${id}-${slug}`;
        }
      });
    });
  });

  // Handle delete
  async function deleteProduct(productId) {
    if (!confirm('Are you sure you want to delete this product?')) return;

    try {
      const res = await fetch(`/products/${productId}`, { method: 'DELETE' });
      const result = await res.json();

      if (res.ok) {
        alert(result.message || 'Product deleted successfully');
        location.reload();
      } else {
        alert(result.error || 'Failed to delete product');
      }
    } catch (err) {
      console.error('Delete error:', err);
      alert('An error occurred while deleting the product');
    }
  }
</script>