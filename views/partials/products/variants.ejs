<%
// Expected backend variables:

// editing: Boolean
// Indicates if this is an edit form

// variants: Optional array of variant objects (only if editing is true)
// Each object should have: { name: String, priceAdjustment?: Number, image?: String }
%>



<%
  // Expected backend variables
  // - editing: Boolean
  // - variants: Optional array of objects like { name: String, priceAdjustment?: Number, image?: String }
  %>
  
  <%
// Expected backend variables:
// - editing: Boolean
// - variants: Optional array of objects like { name: String, priceAdjustment?: Number, image?: String }
%>

<div id="variant-section">
  <label>Product Variants</label>
  <div id="variant-list">
    <% if (editing && variants && variants.length) { %>
      <% variants.forEach((variant, index) => { %>
        <div class="variant-item" data-index="<%= index %>">
          <input type="text" name="variants[<%= index %>][name]" value="<%= variant.name %>" placeholder="Variant Name" required>
          <input type="number" step="0.01" name="variants[<%= index %>][price]" value="<%= variant.price %>" placeholder="Price" required>
          <input type="number" step="0.01" name="variants[<%= index %>][salePrice]" value="<%= variant.salePrice %>" placeholder="Sale Price" required>
          <input type="number" name="variants[<%= index %>][stock]" value="<%= variant.stock || '' %>" placeholder="Stock Quantity" required>

          <% if (variant.image.url) { %>
            <div class="image-preview">
              <img src="<%= variant.image.url %>" alt="Variant Image">
              <button type="button" class="remove-image-btn" onclick="removeImage(<%= index %>, '<%= variant.image.url %>')">Ã—</button>
              <input type="hidden" name="variants[<%= index %>][removedImage]" id="removed-image-<%= index %>">
            </div>
          <% } else { %>
            <input type="file" name="variantImage_<%= index %>" accept="image/*">
          <% } %>

          <button type="button" class="remove-variant-btn" onclick="removeVariant(this)">Remove Variant</button>
        </div>
      <% }); %>
    <% } else { %>
      <div class="variant-item" data-index="0">
        <input type="text" name="variants[0][name]" placeholder="Variant Name" required>
        <input type="number" step="0.01" name="variants[0][price]" placeholder="Price" required>
        <input type="number" step="0.01" name="variants[0][salePrice]" placeholder="Sale Price" required>
        <input type="number" name="variants[0][stock]" placeholder="Stock Quantity" required>
        <input type="file" name="variantImage_0" accept="image/*">
        <button type="button" class="remove-variant-btn" onclick="removeVariant(this)">Remove Variant</button>
      </div>
    <% } %>
  </div>

  <button type="button" onclick="addVariant(<%= editing ? 'true' : 'false' %>)">Add Another Variant</button>
</div>

<script>
  let variantIndex = <%= editing && variants ? variants.length : 1 %>;

  function addVariant(isEditing) {
    const list = document.getElementById('variant-list');
    const item = document.createElement('div');
    item.className = 'variant-item';
    item.dataset.index = variantIndex;

    let inner = `
      <input type="text" name="variants[${variantIndex}][name]" placeholder="Variant Name" required>
      <input type="number" step="0.01" name="variants[${variantIndex}][price]" placeholder="Price" required>
      <input type="number" step="0.01" name="variants[${variantIndex}][salePrice]" placeholder="Sale Price" required>
      <input type="number" name="variants[${variantIndex}][stock]" placeholder="Stock Quantity" required>
      <input type="file" name="variantImage_${variantIndex}" accept="image/*">
      <button type="button" class="remove-variant-btn" onclick="removeVariant(this)">Remove Variant</button>
    `;

    item.innerHTML = inner;
    list.appendChild(item);
    variantIndex++;
  }

  function removeVariant(button) {
    const item = button.closest('.variant-item');
    if (item) item.remove();
  }

  function removeImage(index, imageUrl) {
    const variantItem = document.querySelector(`.variant-item[data-index="${index}"]`);
    const preview = variantItem.querySelector('.image-preview');
    if (preview) preview.remove();

    const fileInput = document.createElement('input');
    fileInput.type = 'file';
    fileInput.name = `variantImage_${index}`;
    fileInput.accept = 'image/*';

    const removeBtn = variantItem.querySelector('.remove-variant-btn');
    variantItem.insertBefore(fileInput, removeBtn);

    const hiddenInput = document.getElementById(`removed-image-${index}`);
    if (hiddenInput) hiddenInput.value = imageUrl;
  }
</script>
  
<%
  //This variant partial submits the following field names as an array of objects:
  
  //variants[0][name]   // (required) Name of the first variant
  //variants[0][priceAdjustment]  // (optional) Price of the first variant
  //variants[0][image]  // (optional) Image URL or path of the first variant

  //variants[1][name]   // Name of the second variant
  //variants[1][priceAdjustment]
  //variants[1][image]

  //...and so on for each added variant.
%>